/* =========================================================
   ðŸœ ã‚¢ãƒªï¼ˆDOMã ã‘ãƒ»è¦‹ãŸç›®ï¼‰
========================================================= */
const ANT_CFG = {
  maxAnts: 2,                 // é€šå¸¸ 1ã€œ2åŒ¹
  spawnIntervalMin: 2500,
  spawnIntervalMax: 5200,
  speedMin: 14,               // px/secï¼ˆé…ã‚ï¼‰
  speedMax: 26,
  yJitter: 2,                 // ä¸Šä¸‹ã®ã‚†ã‚‰ãŽ
  // â˜…ã‚ãªãŸã®ã‚¢ãƒªç”»åƒURLã«å·®ã—æ›¿ãˆã¦ã­
  texL: "https://static.wixstatic.com/media/XXXX_left.png",
  texR: "https://static.wixstatic.com/media/XXXX_right.png",
};

let ants = [];
let antSpawnTimer = null;
let antsRAF = 0;
let antsLastT = 0;

function clearAnts(){
  if (!antsLayer) return;
  ants.forEach(a => a.el.remove());
  ants = [];
  if (antSpawnTimer) { clearTimeout(antSpawnTimer); antSpawnTimer = null; }
  if (antsRAF) { cancelAnimationFrame(antsRAF); antsRAF = 0; }
  antsLastT = 0;
}

function scheduleAntSpawn(){
  if (gameOver) return;
  if (!antsLayer) return;

  const delay = ANT_CFG.spawnIntervalMin + Math.random() * (ANT_CFG.spawnIntervalMax - ANT_CFG.spawnIntervalMin);
  antSpawnTimer = setTimeout(() => {
    if (!gameOver && ants.length < ANT_CFG.maxAnts) spawnAnt();
    scheduleAntSpawn();
  }, delay);
}

function spawnAnt(){
  if (!antsLayer) return;

  // å·¦â†’å³ or å³â†’å·¦
  const fromLeft = Math.random() < 0.5;
  const layerRect = antsLayer.getBoundingClientRect();

  const el = document.createElement("div");
  el.className = "ant";

  const img = document.createElement("img");
  img.alt = "ant";
  img.src = fromLeft ? ANT_CFG.texR : ANT_CFG.texL; // é€²è¡Œæ–¹å‘ã«åˆã‚ã›ã‚‹
  el.appendChild(img);

  // åˆæœŸä½ç½®ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼å¤–ã‹ã‚‰ï¼‰
  const w = 22;
  const startX = fromLeft ? -w : (layerRect.width + w);
  el.style.transform = `translateX(${startX}px)`;

  // å¾®å¦™ãªé«˜ã•ã®ã‚†ã‚‰ãŽ
  const y = (Math.random() * 2 - 1) * ANT_CFG.yJitter;
  el.style.bottom = `${10 + y}px`;

  antsLayer.appendChild(el);

  const speed = ANT_CFG.speedMin + Math.random() * (ANT_CFG.speedMax - ANT_CFG.speedMin);

  ants.push({
    el,
    img,
    x: startX,
    fromLeft,
    speed,
    bobSeed: Math.random() * 1000
  });

  startAntsLoop();
}

function startAntsLoop(){
  if (antsRAF) return;
  antsLastT = performance.now();
  antsRAF = requestAnimationFrame(updateAnts);
}

function updateAnts(t){
  antsRAF = 0;
  if (gameOver) return;
  if (!antsLayer) return;

  const dt = Math.min(0.05, (t - antsLastT) / 1000);
  antsLastT = t;

  const layerW = antsLayer.getBoundingClientRect().width;

  // æ›´æ–°
  ants.forEach(a => {
    const dir = a.fromLeft ? 1 : -1;
    a.x += dir * a.speed * dt;

    // ã¡ã‚‡ã„â€œã¦ãã¦ãâ€æ„Ÿï¼ˆä¸Šä¸‹ã«1pxãã‚‰ã„ï¼‰
    const bob = Math.sin((t * 0.01) + a.bobSeed) * 1.0;
    a.el.style.transform = `translateX(${a.x.toFixed(2)}px) translateY(${bob.toFixed(2)}px)`;
  });

  // ç”»é¢å¤–ã«å‡ºãŸã‚‰æ¶ˆã™
  ants = ants.filter(a => {
    const out = a.fromLeft ? (a.x > layerW + 30) : (a.x < -30);
    if (out) a.el.remove();
    return !out;
  });

  // ã¾ã ç”Ÿå­˜ãŒã„ã‚Œã°ç¶™ç¶š
  if (ants.length > 0) antsRAF = requestAnimationFrame(updateAnts);
}
